<html>

<head>
<script type="text/javascript" src="lib/jquery-1.11.0.min.js"></script>
<script type="text/javascript" src="js/card.js"></script>
<script type="text/javascript" src="js/tichu.js"></script>
<script type="text/javascript" src="js/player.js"></script>
<script type="text/javascript" src="js/table.js"></script>
<script type="text/javascript" src="js/graphics.js"></script>
<script type="text/javascript" src="js/network.js"></script>
<script type="text/javascript" src="js/CombinaisonsValidator.js"></script>
</head>

<body>

<button onclick="Game.enablePlayMode()">Mode jeu</button>
<input type="button" onclick="GameConnection.loadGame('test')" value="Load partie"/>
<input type="text" size="10" id="idName"/>
<input type="button" onclick="GameConnection.connect('test',$('#idName').val())" value="Connexion"/>

<br/>
<canvas id="canvas" width="600" height="400" style="border:solid 1px black"></canvas>

<div id="actions"></div>

<script>

$('#checkMode').click(function(){setCheckMode();});

function setCheckMode(){
	$('#canvas').get(0).addEventListener('mousedown',changeState,false);
}

var canvas = $('#canvas').get(0).getContext('2d');

var move = false;

function changeState(e){
	var x = e.clientX - $('#canvas').offset().left;
	var y = e.clientY - $('#canvas').offset().top;
	var card = findCardsContains(x,y);
	
	if(card != null){
		if(card.checked){
			card.checked = false;
			card.y+=10;
		}
		else{
			card.checked = true;
			card.y-=10;
		}
	}
}





var Actions = {
	div:$('#actions'),
	create:function(actions){
		this.empty();
		actions.forEach(function(action){
			var button = $('<button>' + action.name + '</button>');
			button.bind('click',action.fct);
			this.div.append(button);
		},this);
	},
	empty:function(){
		this.div.empty()
	}
}

var EventHelper = {
	getPosition:function(e){
		var x = e.clientX - $('#canvas').offset().left;
		var y = e.clientY - $('#canvas').offset().top + $('body').scrollTop();
		return {x:x,y:y};
	}
}

var Game = {
	enableSwapMode:function(){
		// Display the position card
		var boxes = [];
		boxes.push(new BoxCard(150,120,35,50));
		boxes.push(new BoxCard(200,100,35,50));
		boxes.push(new BoxCard(250,120,35,50));
		boxes.forEach(function(b){ComponentManager.add(b);});		
		
		this.swapMouseController.enable(boxes);		
		Actions.create([{name:"Echanger",fct:function(){Game.disableSwapMode();}}]);
	},
	disableSwapMode:function(){
		// Proceed to swap
		var boxes = this.swapMouseController.boxes;
		var check = boxes.every(function(b){return b.card!=null;});
		if(!check){
			alert("impossible, choose one card for each");
			return;
		}
		var swapCards = {left:boxes[0].card.card,center:boxes[1].card.card,right:boxes[2].card.card};
		boxes.forEach(function(b){
			ComponentManager.remove(b);
		});
		this.swapMouseController.disable();
		
		this.enablePlayMode();		
	},
	/* Can select the card */
	enablePlayMode:function(){
		this.playMouseController.enable();
	},
	playMouseController:{
		cards:[],
		disable:function(){
			$('#canvas').unbind('mousedown.play');
		},
		enable:function(){
			var _self = this;
			$('#canvas').bind('mousedown.play',function(e){_self._down(e);});
		},
		_down:function(e){
			var coords = EventHelper.getPosition(e);
			var card = CardManager.findSelectCards(PlayerManager.joueur,coords.x,coords.y);
			if(card == null){return;}
			this._checkCard(card);
		}
		,_checkCard:function(card){
			card.checked = !card.checked;
			if(card.checked){
				this.cards.push(card);
			}
			else{
				var pos = this.cards.indexOf(card);
				if(pos!=-1){
					this.cards.splice(pos,1);
				}
			}
			var _self = this;
			if(this.cards.length){
				Actions.create([{
					name:"Jouer",
					fct:function(){
						var cards = _self.cards.map(function(c){return c.card;});
						console.log(CombinaisonsValidator.detect(cards));
					}
				}]);
			}else{
				Actions.empty();
			}
		}		
	},
	swapMouseController:{
		moving:false,
		card:null,
		boxes:null,
		disable:function(){
			this.boxes = null;
			$('#canvas').unbind('mousemove.swap');
			$('#canvas').unbind('mouseup.swap');
			$('#canvas').unbind('mousedown.swap');
		},
		enable:function(boxes){
			this.boxes = boxes;
			var _self = this;			
			$('#canvas').bind('mousemove.swap',function(e){_self.move(e);});
			$('#canvas').bind('mouseup.swap',function(e){_self.up(e);});
			$('#canvas').bind('mousedown.swap',function(e){_self.down(e);});			
		},
		move:function(e){
			if(!this.moving || !this.card){return;}
			var coords = this.getPosition(e);
			this.card.setDirectCoordinates(coords.x-10,coords.y-10);			
		},
		down:function(e){
			var coords = this.getPosition(e);
			var box = this._findBox(coords);
			if(box !=null){
				box.card = null;
			}			
			var card = CardManager.findSelectCards(PlayerManager.joueur,coords.x,coords.y);
			if(card == null){return;}
			this.card = card;
			this.card.originPos = card.originPos || card.getCoords();
			this.moving = true;
			this.move(e);
		},
		getPosition:function(e){
			var x = e.clientX - $('#canvas').offset().left;
			var y = e.clientY - $('#canvas').offset().top + $('body').scrollTop();
			return {x:x,y:y};
		},
		_findBox:function(coords){
			var box = null;
			this.boxes.forEach(function(b){
				if(b.contains(coords.x,coords.y)){
					box = b;
				}
			});
			return box;
		},
		up:function(e){
			if(this.card == null){return;}
			var coords = this.getPosition(e);
			var box = this._findBox(coords);
			// Check if card is in a box
			if(box!=null){
				this.card.setDirectCoordinates(box.x+5,box.y+5);
				box.card = this.card;
			}else{
				// Position the card at the original place
				this.card.setDirectCoordinates(this.card.originPos.x,this.card.originPos.y);
			}
			this.moving = false;
			this.card = null;
		}
	}
}


PlayerManager.init();
CardManager.init();

ComponentManager.run();


</script>


</body>

</html>